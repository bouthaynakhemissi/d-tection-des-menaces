import React, { useState, useRef, useEffect } from 'react';
import styled from 'styled-components';

const ChatContainer = styled.div`
  position: fixed;
  bottom: 100px;
  right: 30px;
  width: 320px;
  height: 420px;
  background: white;
  border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  display: ${({ isOpen }) => (isOpen ? 'flex' : 'none')};
  flex-direction: column;
  z-index: 1000;
  overflow: hidden;
  transition: all 0.3s ease;
  
  @media (max-width: 480px) {
    width: 90%;
    right: 5%;
    bottom: 20px;
    height: 70vh;
  }
`;

const ChatHeader = styled.div`
  background: #2c3e50;
  color: white;
  padding: 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
`;

const ChatBody = styled.div`
  flex: 1;
  padding: 15px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
`;

const Message = styled.div`
  max-width: 80%;
  padding: 10px 15px;
  border-radius: 15px;
  margin-bottom: 10px;
  word-wrap: break-word;
  ${props => props.isUser ? 
    'align-self: flex-end; background: #2c3e50; color: white;' : 
    'align-self: flex-start; background: #f1f1f1; color: #333;'}
`;

const FileInput = styled.input`
  display: none;
`;

const FileInputLabel = styled.label`
  background: #2c3e50;
  color: white;
  padding: 8px 15px;
  border-radius: 20px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  margin-right: 10px;
  font-size: 14px;
  &:hover {
    background: #1a252f;
  }
`;

const InputContainer = styled.div`
  display: flex;
  padding: 10px;
  border-top: 1px solid #eee;
  align-items: center;
`;

const Input = styled.input`
  flex: 1;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 20px;
  outline: none;
  margin-right: 10px;
`;

const SendButton = styled.button`
  background: #2c3e50;
  color: white;
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  &:hover {
    background: #1a252f;
  }
`;

const FloatingButton = styled.button`
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background-color: #4CAF50;
  color: white;
  border: none;
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  font-size: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  transition: all 0.3s ease;
  
  &:hover {
    background-color: #45a049;
    transform: scale(1.1);
  }
`;

const Chatbot = () => {
  const [messages, setMessages] = useState([
    { 
      text: "Bonjour ! Je suis votre assistant en s√©curit√©. Vous pouvez me poser des questions ou m'envoyer des images pour analyse.", 
      sender: 'assistant' 
    }
  ]);
  const [input, setInput] = useState('');
  const [isOpen, setIsOpen] = useState(false);
  const fileInputRef = useRef(null);
  const messagesEndRef = useRef(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      const newMessage = {
        text: `Fichier: ${file.name}`,
        sender: 'user'
      };
      setMessages(prev => [...prev, newMessage]);
      
      // R√©initialiser le champ de fichier apr√®s l'upload
      if (fileInputRef.current) {
        fileInputRef.current.value = '';
      }
      
      // R√©ponse g√©n√©rique pour les fichiers
      setTimeout(() => {
        setMessages(prev => [...prev, { 
          text: "J'ai bien re√ßu votre fichier. Comment puis-je vous aider avec celui-ci ?", 
          sender: 'assistant' 
        }]);
      }, 1000);
    };
    reader.readAsDataURL(file);
  };

  const getSecurityResponse = (userInput) => {
    const securityResponses = {
      'yara': {
        pattern: ['yara', 'r√®gle yara', 'signature yara', 'cr√©er une r√®gle yara'],
        response: "üîç **YARA - Outil de d√©tection de menaces avanc√©**\n\n" +
          "YARA est un outil puissant pour la d√©tection et la classification de logiciels malveillants bas√© sur des r√®gles.\n\n" +
          "**Fonctionnalit√©s avanc√©es :**\n" +
          "- Cr√©ation de r√®gles complexes avec conditions bool√©ennes\n" +
          "- Support des expressions r√©guli√®res et des cha√Ænes hexad√©cimales\n" +
          "- Modules pour l'analyse de fichiers PE, ELF, etc.\n" +
          "- Int√©gration avec d'autres outils de s√©curit√©"
      },
      'sigma': {
        pattern: ['sigma', 'r√®gle sigma', 'd√©tection sigma'],
        response: "üìú **Sigma - Standard pour les r√®gles de d√©tection**\n\n" +
          "Sigma est un format open-source pour la description des r√®gles de d√©tection d'activit√©s suspectes dans les journaux.\n\n" +
          "**Avantages cl√©s :**\n" +
          "- Format ind√©pendant du fournisseur SIEM\n" +
          "- Large biblioth√®que de r√®gles partag√©es\n" +
          "- Facilement maintenable et versionnable\n\n" +
          "**Exemple de r√®gle Sigma :**\n```yaml\ntitle: Suspicious PowerShell Download\nid: 2f0d0cb3-33ec-4f09-9142-7bd1db7e01b1\nstatus: test\ndescription: Detects suspicious PowerShell download\nreferences:\n    - https://www.crowdstrike.com/blog/observations-from-the-front-lines-of-threat-hunting/\nauthor: Florian Roth\ndate: 2019/09/11\nmodified: 2023/01/01\nlogsource:\n    product: windows\n    service: powershell\ndetection:\n    selection:\n        EventID: 4103\n        ScriptBlockText|contains:\n            - 'Invoke-WebRequest'\n            - 'DownloadString'\n    filter:\n        ScriptBlockText|contains:\n            - 'microsoft.com'\n            - 'windowsupdate.com'\n    condition: selection and not filter\nfalsepositives:\n    - Legitimate administrative activity\nlevel: high\ntags:\n    - attack.execution\n    - attack.t1059.001\n```\n\n" +
          "**Int√©grations :**\n" +
          "- SIEM (Splunk, Elastic, QRadar, etc.)\n" +
          "- Outils de Threat Hunting\n" +
          "- Syst√®mes d'orchestration de s√©curit√©"
      },
      'zircolite': {
        pattern: ['zircolite', 'zircolite logs', 'analyse logs windows'],
        response: "üîé **Zircolite - Outil d'analyse avanc√©e des logs Windows**\n\n" +
          "Zircolite est un outil open-source pour l'analyse rapide et l'enrichissement des journaux d'√©v√©nements Windows (EVTX).\n\n" +
          "**Fonctionnalit√©s principales :**\n" +
          "- Analyse rapide des logs EVTX\n" +
          "- Support des r√®gles Sigma\n" +
          "- G√©n√©ration de rapports d√©taill√©s\n" +
          "- Mode distribu√© pour le traitement √† grande √©chelle\n\n" +
          "**Cas d'utilisation :**\n" +
          "- Investigation d'incident de s√©curit√©\n" +
          "- D√©tection d'activit√©s suspectes\n" +
          "- Conformit√© et audit\n\n" +
          "**Exemple de commande :**\n```bash\n# Analyse basique\nzircolite.py --evtx logs/ --ruleset rules/rules_windows_sysmon.json\n\n# Avec r√®gles Sigma\nzircolite.py --evtx logs/ --sigma rules/sigma/ --outfile results.json\n\n# G√©n√©ration de rapport HTML\nzircolite.py --evtx logs/ --ruleset rules/rules_windows_generic.json --format html\n```"
      },
      'loki': {
        pattern: ['loki', 'loki scanner', 'd√©tection ioc'],
        response: "üõ°Ô∏è **LOKI - D√©tecteur d'IoCs**\n\n" +
          "LOKI est un scanner d'Indicateurs de Compromission (IoC) open-source pour les syst√®mes Windows.\n\n" +
          "**Fonctionnalit√©s cl√©s :**\n" +
          "- D√©tection bas√©e sur les signatures YARA\n" +
          "- Analyse des processus en cours\n" +
          "- V√©rification des hachages de fichiers\n" +
          "- D√©tection des connexions r√©seau suspectes\n\n" +
          "**Types d'IoCs d√©tect√©s :**\n" +
          "- Fichiers malveillants\n" +
          "- Processus suspects\n" +
          "- Cl√©s de registre malveillantes\n" +
          "- Connexions r√©seau suspectes\n\n" +
          "**Exemple d'utilisation :**\n```powershell\n# Analyse rapide\n.\\loki.exe -p .\\signatures\n\n# Analyse compl√®te avec rapport\n.\\loki.exe -p .\\signatures -l .\\scan.log --noproc --dontwait --allhds --printall\""
      },
      'threat hunting': {
        pattern: ['threat hunting', 'cyber chasse', 'recherche de menaces', 'chasse aux menaces'],
        response: "üïµÔ∏è **Threat Hunting - Approche proactive de la s√©curit√©**\n\n" +
          "Le Threat Hunting est une approche proactive qui consiste √† rechercher activement des menaces qui ont √©chapp√© aux solutions de s√©curit√© traditionnelles.\n\n" +
          "**M√©thodologie MITRE ATT&CK :**\n" +
          "1. **Reconnaissance** - Collecte d'informations\n" +
          "2. **D√©veloppement des ressources** - Pr√©paration des outils\n" +
          "3. **Acc√®s initial** - Premi√®re compromission\n" +
          "4. **Ex√©cution** - Ex√©cution de code malveillant\n" +
          "5. **Persistence** - Maintien de l'acc√®s\n" +
          "6. **√âl√©vation de privil√®ges** - Obtention de droits √©lev√©s\n" +
          "7. **√âvitement des d√©fenses** - Contournement des s√©curit√©s\n\n" +
          "**Outils recommand√©s :**\n" +
          "- **SIEM** : Splunk, ELK, Microsoft Sentinel\n" +
          "- **EDR** : CrowdStrike, SentinelOne, Microsoft Defender ATP\n" +
          "- **Analyse r√©seau** : Wireshark, Zeek, Suricata\n" +
          "- **Analyse forensique** : Volatility, Autopsy, KAPE"
      },
      'siem': {
        pattern: ['siem', 'security information and event management', 'gestion des √©v√©nements de s√©curit√©'],
        response: "üìä **SIEM - Gestion des √©v√©nements et des informations de s√©curit√©**\n\n" +
          "Un SIEM est une solution qui fournit une analyse en temps r√©el des alertes de s√©curit√© g√©n√©r√©es par les applications et le mat√©riel r√©seau.\n\n" +
          "**Fonctionnalit√©s avanc√©es :**\n" +
          "- Agr√©gation et corr√©lation des logs en temps r√©el\n" +
          "- D√©tection des menaces avanc√©es (APT, zero-day)\n" +
          "- Investigation et r√©ponse aux incidents\n" +
          "- Conformit√© et rapports automatis√©s\n" +
          "- Int√©gration avec les outils de s√©curit√© existants\n\n" +
          "**Workflow typique :**\n" +
          "1. Collecte des logs\n" +
          "2. Normalisation et enrichissement\n" +
          "3. Corr√©lation des √©v√©nements\n" +
          "4. G√©n√©ration d'alertes\n" +
          "5. Investigation et r√©ponse\n\n" +
          "**Solutions avanc√©es :**\n" +
          "- **Splunk** avec ES (Enterprise Security)\n" +
          "- **Microsoft Sentinel** avec int√©gration Azure\n" +
          "- **Elastic SIEM** avec machine learning\n" +
          "- **IBM QRadar** avec IA Watson"
      },
      'soc': {
        pattern: ['soc', 'security operations center', 'centre op√©rationnel de s√©curit√©'],
        response: "üè¢ **SOC - Centre Op√©rationnel de S√©curit√©**\n\n" +
          "Un SOC est une structure organisationnelle qui assure la surveillance continue de la s√©curit√© des syst√®mes d'information.\n\n" +
          "**√âquipe type du SOC :**\n" +
          "- **Niveau 1** : Analystes - Tri des alertes\n" +
          "- **Niveau 2** : Enqu√™teurs - Analyse approfondie\n" +
          "- **Niveau 3** : Experts - R√©ponse aux incidents\n" +
          "- **Responsable SOC** : Coordination et strat√©gie\n\n" +
          "**Outils essentiels :**\n" +
          "- **SIEM** : Centralisation des logs\n" +
          "- **SOAR** : Automatisation des t√¢ches\n" +
          "- **EDR/XDR** : Protection des terminaux\n" +
          "- **Threat Intelligence** : Veille strat√©gique\n\n" +
          "**Indicateurs cl√©s (KPIs) :**\n" +
          "- MTTR (Mean Time To Respond)\n" +
          "- Nombre d'incidents par gravit√©\n" +
          "- Taux de faux positifs\n" +
          "- Couverture de d√©tection"
      },
      'malware': {
        pattern: ['malware', 'logiciel malveillant', 'virus', 'ran√ßongiciel', 'trojan', 'backdoor'],
        response: "ü¶† **Analyse de Malware**\n\n" +
          "Les logiciels malveillants sont des programmes con√ßus pour endommager ou acc√©der de mani√®re non autoris√©e √† des syst√®mes informatiques.\n\n" +
          "**Types principaux :**\n" +
          "- **Virus** : S'attache √† des fichiers propres\n" +
          "- **Vers** : Se propagent automatiquement\n" +
          "- **Troyens** : Se font passer pour des logiciels l√©gitimes\n" +
          "- **Ransomwares** : Chiffrent les donn√©es contre ran√ßon\n" +
          "- **Rootkits** : Cachent la pr√©sence de logiciels malveillants\n\n" +
          "**M√©thodes d'analyse :**\n" +
          "1. **Analyse statique** : Sans ex√©cution\n" +
          "   - Analyse des cha√Ænes de caract√®res\n" +
          "   - Extraction des ressources\n" +
          "   - D√©sassemblage\n" +
          "2. **Analyse dynamique** : Avec ex√©cution contr√¥l√©e\n" +
          "   - Analyse du comportement\n" +
          "   - Surveillance des appels syst√®me\n" +
          "   - Analyse r√©seau\n\n" +
          "**Outils d'analyse :**\n" +
          "- **Analyse statique** : IDA Pro, Ghidra, PEStudio\n" +
          "- **Analyse dynamique** : Cuckoo Sandbox, CAPE, Any.Run\n" +
          "- **Analyse m√©moire** : Volatility, Rekall\n" +
          "- **D√©sobfuscation** : FLOSS, de4dot"
      },
      'd√©tection': {
        pattern: ['d√©tection', 'd√©tecter', 'signature', 'comportement'],
        response: "üîç **Techniques de D√©tection Avanc√©e**\n\n" +
          "**1. D√©tection bas√©e sur les signatures :**\n" +
          "- Utilisation de YARA pour les fichiers\n" +
          "- Signatures r√©seau (Snort, Suricata)\n" +
          "- Hashs de fichiers malveillants\n\n" +
          "**2. D√©tection bas√©e sur le comportement :**\n" +
          "- Analyse des s√©quences d'appels syst√®me\n" +
          "- D√©tection des techniques MITRE ATT&CK\n" +
          "- Analyse des anomalies comportementales\n\n" +
          "**3. D√©tection bas√©e sur le Machine Learning :**\n" +
          "- Classification des fichiers\n" +
          "- D√©tection d'anomalies\n" +
          "- Analyse heuristique\n\n" +
          "**4. Threat Hunting Proactif :**\n" +
          "- Recherche d'IoCs connus\n" +
          "- D√©tection des TTPs (Tactics, Techniques, Procedures)\n" +
          "- Analyse des logs avanc√©e"
      }
    };

    for (const [key, value] of Object.entries(securityResponses)) {
      if (value.pattern.some(term => userInput.toLowerCase().includes(term))) {
        return value.response;  // Retourne uniquement la r√©ponse texte
      }
    }
    return null;
  };

  const getGeneralResponse = (userInput) => {
    if (/bonjour|salut|coucou|hello|hi|hey/i.test(userInput)) {
      return "üëã Bonjour ! Je suis votre assistant en s√©curit√© informatique. Je peux vous aider avec :\n\n" +
             "- Analyse des menaces et malwares\n" +
             "- Configuration de la s√©curit√©\n" +
             "- Bonnes pratiques de cybers√©curit√©\n" +
             "- Outils de s√©curit√© (YARA, SIEM, EDR, etc.)\n\n" +
             "Comment puis-je vous aider aujourd'hui ?";
    } else if (userInput.includes('merci') || userInput.includes('remercie')) {
      return "Je vous en prie ! N'h√©sitez pas si vous avez d'autres questions sur la s√©curit√© ou le Threat Hunting.";
    } else if (userInput.includes('aide') || userInput.includes('aider')) {
      return "üÜò **Aide - Domaines d'expertise**\n\n" +
             "Je peux vous aider avec :\n\n" +
             "**S√©curit√© des syst√®mes :**\n" +
             "- D√©tection des menaces\n" +
             "- R√©ponse aux incidents\n" +
             "- Analyse de malwares\n\n" +
             "**Outils :**\n" +
             "- YARA - Cr√©ation de r√®gles\n" +
             "- SIEM - Gestion des √©v√©nements\n" +
             "- EDR - Protection des terminaux\n\n" +
             "**Bonnes pratiques :**\n" +
             "- S√©curisation des syst√®mes\n" +
             "- Gestion des vuln√©rabilit√©s\n" +
             "- Conformit√© et r√©glementation\n\n" +
             "Posez-moi votre question directement !";
    }
    return null;
  };

  const handleSend = (e) => {
    e.preventDefault();
    if (!input.trim()) return;

    const userMessage = { text: input, sender: 'user' };
    setMessages(prev => [...prev, userMessage]);
    setInput('');
    
    // R√©initialiser le champ de fichier s'il y en a un
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
    
    const userInput = input.toLowerCase();
    
    // V√©rifier d'abord les r√©ponses de s√©curit√©
    const securityResponse = getSecurityResponse(userInput);
    
    // Simuler un d√©lai de r√©ponse
    setTimeout(() => {
      if (securityResponse) {
        setMessages(prev => [
          ...prev, 
          {
            text: securityResponse,
            sender: 'assistant'
          }
        ]);
      } else {
        // V√©rifier les r√©ponses g√©n√©rales
        const generalResponse = getGeneralResponse(userInput);
        setMessages(prev => [
          ...prev,
          {
            text: generalResponse || `Je vais traiter votre demande concernant : "${input}"`,
            sender: 'assistant'
          }
        ]);
      }
    }, 500);
  };

  const renderMessageContent = (message) => {
    return (
      <>
        {message.text && <div>{message.text}</div>}
      </>
    );
  };

  const toggleChat = () => {
    setIsOpen(!isOpen);
  };

  return (
    <>
      <FloatingButton onClick={toggleChat}>
        {isOpen ? '‚úï' : 'üí¨'}
      </FloatingButton>
      <ChatContainer isOpen={isOpen}>
        <ChatHeader onClick={() => setIsOpen(!isOpen)}>
          <span>Assistant S√©curit√©</span>
          <span>{isOpen ? '‚àí' : '+'}</span>
        </ChatHeader>
        
        {isOpen && (
          <>
            <ChatBody>
              {messages.map(message => (
                <Message key={message.text} isUser={message.sender === 'user'}>
                  {renderMessageContent(message)}
                </Message>
              ))}
              <div ref={messagesEndRef} />
            </ChatBody>
            
            <form onSubmit={handleSend}>
              <InputContainer>
                <FileInput
                  type="file"
                  id="file-upload"
                  accept="image/*"
                  ref={fileInputRef}
                  onChange={handleFileUpload}
                />
                <FileInputLabel htmlFor="file-upload">
                  üìé Image
                </FileInputLabel>
                
                <Input
                  type="text"
                  value={input}
                  onChange={(e) => setInput(e.target.value)}
                  placeholder="Tapez votre message..."
                />
                
                <SendButton type="submit">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 2L11 13" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                    <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                </SendButton>
              </InputContainer>
            </form>
          </>
        )}
      </ChatContainer>
    </>
  );
};

export default Chatbot;
